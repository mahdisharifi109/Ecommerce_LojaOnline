rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function isAdmin() {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // --- GLOBAL ADMIN OVERRIDE ---
    // Allows admins to read/write ANY document in the database
    match /{document=**} {
      allow read, write: if isAdmin();
    }

    // --- Users Collection ---
    match /users/{userId} {
      // Allow public read access to user profiles (needed for seller info)
      allow read: if true;
      // Only owner can write/edit their own profile
      allow write: if isOwner(userId);
      
      match /settings/{document=**} {
        allow read, write: if isOwner(userId);
      }
    }

    // --- Stats Collection (Admin Dashboard) ---
    match /stats/{document=**} {
      allow read: if isAdmin();
      // Only admins or system functions should write stats
      // We allow write if admin for now, as the client updates it in some cases
      allow write: if isAdmin();
    }

    // --- Products Collection ---
    match /products/{productId} {
      allow read: if true;

      allow create: if isAuthenticated() 
                    && request.resource.data.price > 0
                    && request.resource.data.name.size() > 3
                    && request.resource.data.name.size() < 100
                    && request.resource.data.userId == request.auth.uid;

      allow update: if isAuthenticated() && (
        // Owner can update everything
        resource.data.userId == request.auth.uid ||
        // Buyer can mark as sold
        (resource.data.status == 'available' && request.resource.data.status == 'sold' && request.resource.data.buyerId == request.auth.uid) ||
        // Reviewers can ONLY update rating and reviewCount
        // We use diff() to ensure only these fields change.
        // We also add a fallback check for critical fields in case diff() behaves unexpectedly with new fields.
        (
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['rating', 'reviewCount']) ||
          (
            request.resource.data.price == resource.data.price &&
            request.resource.data.userId == resource.data.userId &&
            request.resource.data.name == resource.data.name &&
            request.resource.data.description == resource.data.description &&
            request.resource.data.status == resource.data.status
          )
        )
      );
    }

    // --- Reviews Collection ---
    match /reviews/{productId}/user_reviews/{reviewId} {
      allow read: if true;
      // Allow any authenticated user to create a review (validation happens in UI/Service)
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // --- Carts Collection ---
    match /carts/{cartId} {
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // --- Orders Collection ---
    match /orders/{orderId} {
      // Only the user can create their own order
      allow create: if isAuthenticated() 
                    && request.resource.data.userId == request.auth.uid;
      
      // Only the user can read their own orders
      allow read: if isAuthenticated() 
                  && resource.data.userId == request.auth.uid;
      
      // NO ONE can update an order after creation (except system via Admin SDK)
      // This prevents users from changing order status or amount paid
      allow update: if false;
      
      // NO ONE can delete an order
      allow delete: if false;
    }

    // --- Transactions Collection ---
    match /transactions/{transactionId} {
      allow read: if isAuthenticated() && (
        request.auth.uid == resource.data.buyerId || 
        request.auth.uid == resource.data.sellerId
      );
      // Allow creation if authenticated (usually done by client after payment)
      allow create: if isAuthenticated() && (
        request.resource.data.buyerId == request.auth.uid ||
        request.resource.data.sellerId == request.auth.uid
      );
    }

    // --- Conversations Collection ---
    match /conversations/{conversationId} {
      allow read: if isAuthenticated() && resource.data.participantIds.hasAny([request.auth.uid]);
      allow create: if isAuthenticated() && request.resource.data.participantIds.hasAny([request.auth.uid]);
      allow update: if isAuthenticated() && resource.data.participantIds.hasAny([request.auth.uid]);

      match /messages/{messageId} {
        allow read: if isAuthenticated() && 
          get(/databases/$(database)/documents/conversations/$(conversationId)).data.participantIds.hasAny([request.auth.uid]);
        allow create: if isAuthenticated() && 
          get(/databases/$(database)/documents/conversations/$(conversationId)).data.participantIds.hasAny([request.auth.uid]) &&
          request.resource.data.senderId == request.auth.uid;
      }
    }

    // --- Notifications Collection ---
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated(); 
    }
  }
}
